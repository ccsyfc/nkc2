extends bootstrap_base.jade

block title
  title #{data.forum.display_name} - #{data.site.name}
  
  -var forum  = data.forum
  if forum.description
    -var processed=forum.description.replace(/\[.*?]|\#|\n|\<.*?>/gm,'').trim().slice(0,140)
  else
    -var processed = forum.display_name
    
  meta(name='description' content='#{processed}')
  
  meta(property='og:image' content='http://bbs.kechuang.org/resources/site_specific/umaru_chem_300x200.png')
  meta(property='og:title' content='#{forum.display_name}')
  meta(property='og:site_name' content='科创论坛')
  meta(property='og:description' content='#{processed}')
  
  if data.threads.length>0
    meta(property='article:modified_time' content='#{(new Date(data.threads[0].toc)).toISOString()}')
  
  style.
    .marginless {
      margin-top:7px;
      margin-bottom:7px;
      margin-right:15px;
    }

block content   
  
  -var forumIsParent = data.forum.type&&data.forum.type=='category'
  -var hasChildren = data.forum.type&&data.forum.type=='category'&&data.forums&&data.forums.length
  
  .container-fluid(style='max-width:1400px;')
    .row

      .col-md-9
      
        //split 10/12 for post area
        #fullwidthpanel.nkcpanel
          if !forumIsParent
            //if forum is not category
            .row
              .col-xs-12
                //img(src='http://bbs.kechuang.org/themes/site/dingzhi/images/logo.png')
                if(data.forum._key)
                  .ForumNavigation1
                    each group,index in data.forumlist

                      -var gpf = group.parentforum
                      if gpf._key == data.forum.parentid
                      
                        -var gpf = group.parentforum
                        -var name = gpf.display_name
                        -var url = '/f/'+gpf._key
                        a(href='#{url}' class='parentforum') #{name} /
                      
                        each f,findex in group.forumgroup
                          -var name = f.display_name
                          -var url = '/f/'+f._key
                          a(href='#{url}' class='#{f._key==data.forum._key?"active":""}') #{name}
                    
                
                -var forum = data.forum
                .ForumTitleCircle(style='background-color:#{forum.color}')
                .ForumName #{forum.display_name}

                if data.forum.description
                  div!=markdown_safe(data.forum.description)
              
              
                div
                  span(style='margin-right:20px;') 今日: #{data.forum.count_posts_today} 主题: #{data.forum.count_threads} 回复: #{data.forum.count_posts}
        
                  if data.forum.moderators && data.forum.moderators.length
                    span 版主：
                      - var moderators = data.forum.moderators
                      each k in moderators
                        a.d-inline.margin-right(href='/user_profile_byname/#{k}') #{k}
                      
                if data.forumthreadtypes && data.forumthreadtypes.length
                  div
                    hr.hrNarrowSpace
                    span 分类: 
                    a(href='/f/#{data.forum._key}' style='margin-right:10px;') 所有帖子
                    each ftt in data.forumthreadtypes
                      a(href='/f/#{data.forum._key}?cat=#{ftt._key}' style='margin-right:10px;') #{ftt.name}
          
          if forumIsParent
            //if forum is category
            .ForumNavigation1
              each group,index in data.forumlist
                -var gpf = group.parentforum
                -var name = gpf.display_name
                -var url = '/f/'+gpf._key
                a(href='#{url}' class='#{gpf._key==data.forum._key?"active":""}') #{name}
              
            .ForumNavigation2.row
              each forum,index in data.forums
                -var f = forum
                -var name = f.display_name
                -var url = '/f/'+f._key; // url=seo_reverse_rewrite(url)
                -var p = data.forum
                if (forum!=null)
                  if 1
                    if index%4==0
                      .clearfix.visible-lg-block
                    if index%4==0
                      .clearfix.visible-md-block
                    if index%3==0
                      .clearfix.visible-sm-block
                    if index%2==0
                      .clearfix.visible-xs-block
                      
                .col-xs-6.col-sm-4.col-md-3
                  .ForumNaviProf
                    include interface_forumprofile2.jade
                  
        
        if hasChildren && 0
          //older ver, discarded
          each forum,index in data.forums
            -var f=forum;var p=data.forum
            .nkcpanel#fullwidthpanel
              .HomeForumTitle
                - var forumcolor = f.color||p.color||'#eee'
                - var url = '/f/'+f._key; url = seo_reverse_rewrite(url)
                
                .HomeForumTitleCircle(style='background-color:#{forumcolor}')
                a.HomeForumTitlePrimary(href='#{url}') #{f.display_name}
                  
                .HomeForumTitleSecondary
                  if f.count_posts_today > 0
                    span.HomeForumTitlePostCountToday #{f.count_posts_today||""}/ 
                    
                  span.HomeForumTitleThreadCount #{f.count_threads}/ 
                  span.HomeForumTitlePostCount #{f.count_posts}
                  
              p #{f.description}
              hr.hrNarrowSpace
              .ForumThreadList
                each thread,index in forum.threads
                  include interface_forum_singlethread.jade
                  
        if hasChildren
          -var threads = data.forums.map(i=>i.threads).reduce((a,b)=>b.concat(a)).sort((a,b)=>b.tlm-a.tlm).slice(0,30)
          
          .nkcpanel#fullwidthpanel
            .ForumThreadList
              each thread,index in threads
                include interface_forum_singlethread.jade

          
        if !hasChildren  
          .nkcpanel#fullwidthpanel
            .row
              .col-xs-12
                .form-group(style='margin-top:0px;margin-bottom:6px')
                  if data.replytarget
                    
                    a.btn.btn-default(href='/editor?target=#{data.replytarget}') 新帖
                
                    button#enterManagementMode.btn.btn-default(onclick='enterManagementMode()') 管理
                    
                .ForumManagement(style='display:none;margin-top:12px;margin-bottom:12px')

                  .form-inline(style='margin-top:10px')
                    
                    if data.permittedOperations.addThreadToCollection
                      .form-group
                        button#addSelectedToMyCollection.btn-xs.btn.btn-default(onclick='addSelectedToMyCollection()') 添加到个人收藏
                  
                    .form-group
                      button.btn.btn-xs.btn-default(onclick='selectbtn()') 全选/不选  
                    .form-group
                      include forumlist_dropdown.jade
                      button(onclick="javascript:moveThreadTo()") 移动
                    
                    .form-group
                      button#recyclebtn.btn.btn-xs.btn-danger(onclick='recyclebtn()') 送回收站
                    

              .col-xs-12
                nav
                  include interface_navigation_paging.jade
                  
                  - var paging = data.paging
                  - var digest = data.digest
                  - var class_str_all = digest?'':'active'
                  - var class_str_digest = digest?'active':''
                  
                  - var cat = data.cat
                  - var sortby = data.sortby
                  - var class_str_sortby_toc = sortby?'active':''
                  - var class_str_sortby_tlm = sortby?'':'active'
                  
                  ul.pagination.NavigationPaging
                    - var page = paging?paging.page:null
                    li(class="#{class_str_all}")
                      a(href='#{toQueryString({cat})}') 俱
                      
                    li(class="#{class_str_digest}")
                      a(href='#{toQueryString({cat,digest:true})}') 精
              
                  ul.pagination.NavigationPaging
                    li(class='#{class_str_sortby_tlm}')
                      a(href='#{toQueryString({cat,digest})}') 复序
                    li(class='#{class_str_sortby_toc}')
                      a(href='#{toQueryString({cat,digest,sortby:"toc"})}') 帖序
                      
                  
                hr.hrNarrowSpace  
                  
            if data.toppedThreads && data.toppedThreads.length>0
              .ForumThreadList
                each thread,index in data.toppedThreads
                  include interface_forum_singlethread.jade
              //hr.hrNarrowSpace
              .ForumToppedSplitter - 以上是置顶 -

            .ForumThreadList
              each thread,index in data.threads
                if data.toppedThreads && (data.toppedThreads.map(item=>item._key).indexOf(thread._key)>=0)
                  //exclude threads that are shown in topped area.
                else
                  include interface_forum_singlethread.jade

            .row
              .col-md-12
                nav
                  include interface_navigation_paging.jade
              
                if data.replytarget
                  a.btn.btn-default(style="margin-top:13px" href='/editor?target=#{data.replytarget}') 新帖
              
      .col-md-3.hidden-xs.hidden-sm
        .nkcpanel
          include forum_logo_wisdom.jade
        
        -var skipOtherParent = true
        if data.forum._key
          include interface_forums_list.jade
        -skipOtherParent=false
          
        .nkcpanel
          -var f = data.forum
          -var p = data.forum
          include interface_forumprofile2.jade
          
        .nkcpanel
          ul.HomeFriendlyLink
            include nkc_footer_links.jade
        
        if !forumIsParent
          include interface_forums_list.jade
  include debug_output.jade

block scripts
  script(src='/interface_common.js')
  script(src='/interface_collections.js')
  script(src='/interface_forum.js')
  
  -var isModerator = data.permittedOperations.moveThread
  if isModerator&&!forumIsParent
    script.
      enterManagementMode()
